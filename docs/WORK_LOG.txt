# Claim — Work Log
# Updated: 2026-02-21 ~19:30 EST

---

## 2026-02-21 ~18:00-19:30 EST

- Ship spec cleanup: updated `ship_data.gd` CLASS_STATS to GDD S8.2 canonical values - Courier (0.38g/38t/54m3/46.5fuel/73.4t dry/crew2/slots3), Hauler (0.19g/412t/584m3/237fuel/488.2t dry/crew5/slots5), Prospector (0.31g/107t/143m3/118fuel/214.8t dry/crew3/slots4), Explorer (0.47g/63t/91m3/192fuel/141.6t dry/crew2/slots4)
- Per-ship variance updated to GDD S8.2 spreads: +-5% dry mass, +-5% thrust, +-10% cargo mass, +-10% cargo volume, +-8% fuel, +-1 slot; removed uniform +-7%
- Python server ship stats synced to match GDD in `server/server/models/ship.py`
- Policy system added: SupplyPolicy (PROACTIVE/ROUTINE/MINIMAL/MANUAL), CollectionPolicy (AGGRESSIVE/ROUTINE/PATIENT/MANUAL), EncounterPolicy (AVOID/COEXIST/CONFRONT/DEFEND) - added to `company_policy.gd` with names, descriptions, and threshold constants
- `game_state.gd`: added supply_policy, collection_policy, encounter_policy vars; wired into save/load
- `simulation.gd` _station_try_provisioning: replaced hardcoded 5-day threshold with CompanyPolicy.SUPPLY_POLICY_THRESHOLDS[GameState.supply_policy]; switched from deployed_crews to asteroid_supplies+get_asteroid_supply_days() for threshold check; skips if MANUAL
- `simulation.gd`: added _station_try_collect_ore() - auto-collects stockpiled ore when stockpile >= cargo_capacity * CollectionPolicy threshold; skips if MANUAL; added collect_ore to station job dispatch match
- `simulation.gd` _complete_delivery_job: now delivers food/parts to both deployed_crews (legacy) AND asteroid_supplies (mining units model) by proximity matching to nearest asteroid
- `dashboard_tab.gd`: replaced single thrust policy row with a generic _add_policy_row helper; now shows all 4 policies (Thrust, Resupply, Ore Collection, Encounter) each with name dropdown and live description label
- Python server skeleton created at `server/`: FastAPI + SQLAlchemy async + PostgreSQL; routers for auth/game/events/admin; simulation runs as background asyncio task (1 real second = 1 game tick at 1x); SSE event stream; seed script; Alembic migrations; full README with Windows setup instructions
- Python policy enum comments fixed in `server/server/models/player.py` to match GDScript enum values exactly

## 2026-02-21 ~17:00–17:30 EST

- Fixed redirect fuel check: previously only checked one-way fuel to new destination; ship could arrive stranded with nothing left for return trip
- Fixed redirect `fuel_per_tick`: was set to `ship.fuel / transit_time` (burning ALL remaining fuel on outbound leg, leaving 0 for return); now uses round-trip rate `(fuel_out + fuel_ret) / (outbound_time + return_time)` matching `start_mission`'s pattern
- Both `redirect_mission` and `redirect_trade_mission` now: (1) compute return fuel from new_dest back to home (Earth/station), (2) check total against ship.fuel, (3) use round-trip `fuel_per_tick`
- `redirect_cost` now based on `fuel_out` only (not total round-trip) — redirect penalty is for the course change, not the full mission
- Updated `fleet_market_tab.gd` redirect popups to use round-trip feasibility check and show correct infeasibility message

## 2026-02-21 ~16:30–17:00 EST

- Fixed mission origin display: fleet tab now shows actual origin name (e.g., "Castalia") instead of "Earth"/"Space"
- Root cause 1: `start_mission` never set `origin_is_earth` — it defaulted to `true`, so all missions started from non-Earth showed "Earth"
- Root cause 2: "Earth"/"Space" binary was never expressive enough; needed `origin_name` field
- Added `origin_name: String` to `mission.gd` and `trade_mission.gd`
- `start_mission`: now sets `origin_is_earth` from ship position + `origin_name` from Earth/colony
- `dispatch_idle_ship`: captures previous asteroid name BEFORE clearing idle mission, then sets `origin_name` on new mission (e.g., "Castalia")
- `dispatch_idle_ship_trade`: same, captures colony name
- `start_trade_mission`: now sets `origin_is_earth` + `origin_name` (was also missing)
- `start_deploy_mission` / `start_collect_mission`: already had `origin_is_earth`, added `origin_name`
- `fleet_tab.gd`: uses `origin_name` if set, falls back to "Earth"/"Space"
- Save/load: added `origin_name` to both Mission and TradeMission save/load dicts

## 2026-02-21 ~16:00–16:30 EST

- Added ship speed display to solar map: `ship_marker.gd` `_update_label()` shows `"ShipName\n{N} km/s"` for speed ≥ 0.5 km/s; speed from `thrust × 9.81 × transit_time × min(t, 1-t)` (fixed mission params, not live orbital positions which inflate due to drift); label rect height fixed in `ship_marker.tscn` (`offset_bottom` 10→28, 38px total)
- Implemented redirect momentum arc in `game_state.gd`: ships no longer snap direction instantly on redirect. Two-leg route: leg 1 continues in current velocity direction (`arc_fraction * dist`), leg 2 turns to new destination. `arc_fraction = clamp(sqrt((1-dot)/2) * speed_fraction * 0.4, 0, 0.30)`. Falls back to single-leg if arc < 5% or if ship speed too high for arc length (initial_t ≥ 0.48). Uses existing `outbound_waypoints`/`outbound_leg_times` multi-leg infrastructure.
- Velocity preservation on redirect: speed magnitude preserved via `initial_t = clamp(speed / (4 × avg_v), 0, 0.5)`, virtual origin pushed backward so position is correct at entry time. Applied to both Mission redirects and TradeMission redirects.

## 2026-02-21 ~15:00–16:00 EST

- Fixed HQ tab horizontal expansion: added SIZE_EXPAND_FILL + clip_text to labels in dashboard_tab.gd (_refresh_stationed_ships, _refresh_discipline, _refresh_resources, _refresh_alerts, _refresh_activity, _refresh_contracts, _refresh_balance_history)
- Fixed ships staying at asteroids permanently: IDLE_AT_DESTINATION ships have non-null current_mission, causing them to route into the redirect path. Fixed _on_map_dispatch_asteroid and _on_map_dispatch_colony to check specific transit statuses (TRANSIT_OUT, TRANSIT_BACK, REFUELING) instead of just if ship.current_mission
- Fixed _return_to_map_if_needed never firing: _hide_dispatch() was resetting _dispatched_from_map=false before the check; reordered calls in _execute_dispatch, _queue_mission, _select_colony_trade
- Fixed redirect fuel calculation: calculate_course_change converted AU/tick velocity to km/s producing astronomically large fuel estimates; replaced with ship.calc_fuel_for_distance(dist) in both fleet_market_tab.gd and game_state.gd
- Fixed silent failure on infeasible redirect: now always shows popup with Confirm/Cancel if feasible, or Close + reason if not
- Fixed ship position jumping back to Earth on redirect: redirect_mission and redirect_trade_mission now set origin_position_au = ship.position_au and origin_is_earth = false before resetting elapsed_ticks, preventing interpolation from restarting at Earth's current position
- Fixed ships stopping and changing direction when redirected: when a TRANSIT_BACK ship was redirected, only mission.asteroid changed but elapsed_ticks/transit_time stayed the same — the lerp start-point snapped to the new asteroid's position (potentially across the solar system). Fixed by always resetting to TRANSIT_OUT from ship's current position regardless of prior status, same fix in redirect_trade_mission
- Implemented velocity-preserving redirects: ships no longer stop and restart from rest when redirected. The brachistochrone is entered at initial_t = clamp(speed / (4 * avg_velocity), 0, 0.5) so speed is preserved. The virtual origin is pushed behind the ship (adjusted_origin = (pos - dest*dfrac)/(1-dfrac)) so position is also correct at initial_t. The popup displays the effective remaining transit time (1-initial_t)*T instead of the from-rest time

## 2026-02-21 ~14:00–15:00 EST

- Added 7 ship names to ship_data.gd: "A Searing Epiphany", "Squandered Fortune", "Laziness in Action", "Wandering Minstrel", "Faith Like a Candle", "Slurry", "Dastardly Cur"
- Confirmed orphan worker autotest error has not recurred — marked resolved in handoff doc
- Implemented Solar Map Dispatch (see previous session entry)

## 2026-02-21 ~13:00–14:00 EST

- Implemented Solar Map Dispatch feature — player can now dispatch ships spatially from the map
- event_bus.gd: Added map_dispatch_to_asteroid(ship, asteroid) and map_dispatch_to_colony(ship, colony) signals
- solar_map_view.gd: Added dispatch mode — clicking a docked ship in the left panel selects it (green border), then clicking an asteroid or colony emits dispatch signal; RMB or Escape cancels; hint label shows at bottom while in dispatch mode
- main_ui.gd: Connected map dispatch signals → auto-switches to Fleet tab (index 1)
- fleet_market_tab.gd: Added _on_map_dispatch_asteroid() and _on_map_dispatch_colony() — opens dispatch popup directly at worker selection or colony confirm, skipping the destination list

## 2026-02-21 ~11:28–13:00 EST

- Fixed remaining 4 IDLE_AT_DESTINATION transitions in simulation.gd — added mission.workers.clear() after worker-freeing loops (mining done, fuel stop abort, _complete_deploy, _complete_collection)
- Added ore sale transaction logging to market_tab.gd — _sell_all_ores() and _sell_ore() now call record_transaction() (auto-sell at colonies was already logged)
- Investigated "orphan worker in mining unit" autotest error — traced through fire_worker, deploy_mining_unit, _complete_deploy, _process_worker_leave; root cause NOT YET FOUND (see handoff)
- Explained --dangerously-skip-permissions flag and how to set defaultMode in ~/.claude/settings.json

## 2026-02-21 ~10:00–11:28 EST

- Introduced WORK_LOG.txt as a standard end-of-session doc (replaces GIT_LOG.txt)
- Retroactively populated work log with full project history, organized as time ranges
- Updated MEMORY.md and CLAUDE_HANDOFF.md to include WORK_LOG.txt in the update-docs routine
- "update docs" established as the end-of-session command to update WORK_LOG, HANDOFF, and GDD
- Diagnosed false positive leak: ContractsList fills to ~48 nodes (bounded by data caps), not an actual leak
- Fixed leak detector GameState logging: Engine.has_singleton() doesn't work for autoloads, changed to is_instance_valid(GameState)
- Verified worker personality traits fully implemented across all 6 files
- Tick batching fix confirmed: EventBus.tick now emitted once per frame instead of once per simulation step (~30x overhead reduction at SPEED_MAX)
- financial_history trimming changed from slice() to remove_at(0) to avoid allocation
- Ship outfitting tab horizontal expansion finally fixed: clip_text = true on all labels + refresh guard against stacked call_deferred

## 2026-02-21 ~08:00–10:00 EST

- CRITICAL FIX: Food consumption was 100x too fast — unit conversion bug (1 unit = 100kg, not 1kg)
- CRITICAL FIX: Ship teleportation — docked_at_colony not cleared on Earth return caused ships to snap back to old colony
- Auto-provisioning: ships now automatically purchase food when docking at colonies (30-day buffer)
- Test harness: provisions ships before dispatch, mission redirects increased (15%→30% mining, 20% trade added), ships queue next job while busy
- Comprehensive code review vs GDD: multiple features marked "not implemented" were actually fully functional
- Mining units, cargo volume, mining slots, ore stockpiles all confirmed complete
- GDD updated to v0.7: accurate status for mining units, cargo volume, Phase 2b roadmap (8 features marked DONE)
- IMPLEMENTATION_STATUS.md written documenting GDD claims vs actual codebase reality

## 2026-02-20 ~16:00–17:00 EST

- Worker XP system: pilot_xp, engineer_xp, mining_xp fields; quadratic XP curve; skills cap at 2.0
- XP accumulates in simulation: pilot XP during transit, mining XP during extraction, engineer XP on repairs
- Wage auto-scales on level-up; small loyalty bonus per level
- XP progress bars in Workers tab, level-up notifications in dashboard activity feed
- worker_skill_leveled signal added
- Worker personality traits: AGGRESSIVE, CAUTIOUS, LOYAL, GREEDY, LEADER
- Each type modifies mining output, fatigue rate, accident rate, quit chance, tardiness rate
- Greedy workers demand wage raises every 30 game-days if loyalty < 60
- Leader aura: +5% crew mining, -5% crew fatigue for non-Leaders
- Personality saves/loads with LOYAL as default for old saves
- Mining units: full end-to-end system — purchase, deploy, passive ore accumulation, stockpiles, collect, durability degradation, all save/load
- LeakDetector autoload created (F6 overlay, writes to leak_log.txt)
- Test harness created for automated gameplay testing at max speed
- Dashboard tab major expansion: contracts ticker, stationed ships panel, discipline panel, collapsible sections, balance history, reputation, company policies, activity feed, alerts

## 2026-02-20 ~06:43–07:44 EST

- Physics-based rescue system: derelict ships maintain velocity, intercept trajectory, life support tracking
- Complete save/load: missions, trade missions, contracts, market events, fabrication queue, reputation, rescue/refuel missions
- Ship purchasing backend: pricing for all 4 classes, purchase_ship(), ship spawns at Earth fully fueled
- Ship purchasing UI: popup showing all 4 classes with specs and prices, color-coded affordability
- Automated fuel stop routing: FuelRoutePlanner utility, greedy nearest-colony algorithm, waypoint metadata on missions, dispatch UI preview
- CRITICAL FIX: Life support not reset on rescue — ships died instantly on second breakdown
- Engineer self-repair: crew can patch breakdowns in-place before full derelict (0–50% by skill)
- Space key toggles between 1x and previous speed
- docs/ folder created; CLAUDE_HANDOFF.md, GDD.md, LORE.md moved there

## 2026-02-19 ~19:37–22:13 EST

- CRT shader disabled (every pixel every frame)
- Starfield throttled (1000–3000+ circles/frame)
- Patched conics trajectory visualization: replaced forward simulation with analytical conic math (KSP-style, 10–100x faster)
- Orbital updates, label overlap detection, date display, dashboard ticks all throttled to wall-clock intervals
- Sun-only gravity for drifting derelicts
- Ships targeting stale Earth positions fixed, jerkiness at high speed fixed
- CLAUDE_HANDOFF.md created for multi-machine coordination
- Design conversation: server stack (Python/PostgreSQL), policy system, two-tier alerts, colony tiers, consortia, light-speed delay, piracy balance
- GDD v0.5: design pillars, communication delay, policy system, alert system, colony tiers, HQ mechanics, consortia sections all written

## 2026-02-18 ~16:53–21:25 EST

- GDD first full draft (~780 lines)
- Reputation system: model, score, tiers
- Ephemeris verifier: validates positions against JPL data
- Worker model: home colony, loyalty, leave status, fatigue
- JPL ephemeris data integrated into celestial positions
- Solar map: ship markers, orbit rendering, label overlap detection
- Market: random walk pricing, buy/sell UI
- Dashboard: missions, resources, workers, alerts
- Trajectory visualization experiments (forward simulation approach, later replaced by patched conics)
- Trade missions: buy/sell at colonies, revenue calculation
- Ship outfitting tab: equipment upgrades, mining unit management
- Dashboard: financial history, transaction log

## 2026-02-18 ~07:28–07:45 EST

- JPL ephemeris data: real orbital elements for all planets and major bodies
- Colony positions tied to orbital mechanics
- HTTP fetcher service for ephemeris
- Solar map orbit path rendering
- TimeScale autoload: speed control (1x through max), game clock formatting
- Speed controls in main UI

## 2026-02-17 ~19:29–22:42 EST

- Contracts: offer/accept/complete/fail, deadlines, rewards
- Market events: random price shocks
- Ship upgrades: model, catalog, equipment slots
- Brachistochrone trajectory calculation
- Solar map: ship markers, orbit visualization
- TimeScale autoload
- Fleet tab: ship list, status, basic dispatch
- Market tab: prices, buy/sell
- All 4 ship classes defined: Courier, Prospector, Explorer, Hauler (thrust/cargo/fuel specs)
- Fuel pricing: colony-based costs, distance scaling
- Company policy system: thrust strategy
- Trade mission model: full buy/sell flow
- Fleet dispatch UI: crew selection, route preview, fuel cost
- Solar map: ship movement along trajectory
- LORE.md created

## 2026-02-16 ~18:42–21:42 EST

- Project created in Godot 4
- Core autoloads: EventBus, GameState, Simulation
- Core models: Ship, Worker, Mission, Equipment, Colony, Contract, TradeMission
- Core data: AsteroidData, CelestialData, MarketData, ResourceTypes
- Market tab, Fleet tab, Workers tab, Dashboard tab initial builds
- Solar map skeleton
- Brachistochrone physics stub

## 2026-02-21 FastAPI server scaffold

- Created `server/` directory with full Python/FastAPI server implementation
- SQLAlchemy 2.0 async + PostgreSQL (asyncpg) + Alembic migrations configured
- ORM models: Player, Ship, Worker, Mission, Asteroid, Colony
- Auth: bcrypt password hashing, JWT tokens, OAuth2 Bearer scheme
- REST routers: /auth (register/login/me), /game (state/dispatch/hire/fire/buy-ship/policies/asteroids/colonies/market), /events (SSE stream), /admin (status/seed/give-starter-pack)
- Simulation background asyncio task: missions (transit/mining/return), market random walk, payroll deduction
- In-memory EventBus for SSE push to all connected clients
- Seed data: 20 real asteroids with Keplerian orbital elements, 9 colonies with price multipliers
- Standalone seed.py script: creates tables, seeds data, creates default player1 with Prospector ship + 3 workers
- README.md with setup instructions and full API reference
